<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audi Wyoming Valley - Time Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f3f4f6;
        }

        /* Audi Brand Colors */
        .audi-black { background-color: #000000; color: white; }
        .audi-red { color: #bb0a30; }
        .bg-audi-red { background-color: #bb0a30; }
        .hover-audi-red:hover { background-color: #990000; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Print Styles for PDF Generation */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 20px;
            }
            .no-print {
                display: none !important;
            }
        }

        .btn-action {
            transition: all 0.2s;
        }
        .btn-action:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-4xl glass-panel p-8 relative overflow-hidden min-h-[600px] flex flex-col">
        
        <!-- Header / Logo -->
        <div class="text-center mb-8 border-b pb-4">
            <img src="audi-logo.jpg" alt="Audi Logo" class="h-24 mx-auto mb-2 object-contain" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/9/92/Audi-Logo_2016.svg/2560px-Audi-Logo_2016.svg.png'">
            <h1 class="text-2xl font-bold text-gray-800 tracking-wider">TIME TRACKER SYSTEM</h1>
            <p class="text-gray-500 text-sm">Audi Wyoming Valley</p>
        </div>

        <!-- Notification Area -->
        <div id="notification" class="hidden fixed top-5 right-5 px-6 py-3 rounded shadow-lg text-white font-bold z-50 transition-all duration-300 transform translate-y-0"></div>

        <!-- VIEW: Login Screen -->
        <div id="view-login" class="flex-1 flex flex-col items-center justify-center space-y-6">
            <h2 class="text-xl font-medium text-gray-600">Enter Your PIN</h2>
            
            <div class="flex flex-col items-center space-y-4">
                <input type="password" id="pin-input" maxlength="5" class="text-center text-4xl tracking-[1em] w-64 border-b-2 border-gray-300 focus:border-red-700 outline-none bg-transparent py-2 transition-colors" placeholder="••••">
                
                <!-- Numeric Keypad -->
                <div class="grid grid-cols-3 gap-4 mt-6">
                    <button onclick="addToPin('1')" class="w-16 h-16 rounded-full bg-white border border-gray-200 shadow hover:bg-gray-50 text-xl font-medium text-gray-700 active:bg-gray-200">1</button>
                    <button onclick="addToPin('2')" class="w-16 h-16 rounded-full bg-white border border-gray-200 shadow hover:bg-gray-50 text-xl font-medium text-gray-700 active:bg-gray-200">2</button>
                    <button onclick="addToPin('3')" class="w-16 h-16 rounded-full bg-white border border-gray-200 shadow hover:bg-gray-50 text-xl font-medium text-gray-700 active:bg-gray-200">3</button>
                    <button onclick="addToPin('4')" class="w-16 h-16 rounded-full bg-white border border-gray-200 shadow hover:bg-gray-50 text-xl font-medium text-gray-700 active:bg-gray-200">4</button>
                    <button onclick="addToPin('5')" class="w-16 h-16 rounded-full bg-white border border-gray-200 shadow hover:bg-gray-50 text-xl font-medium text-gray-700 active:bg-gray-200">5</button>
                    <button onclick="addToPin('6')" class="w-16 h-16 rounded-full bg-white border border-gray-200 shadow hover:bg-gray-50 text-xl font-medium text-gray-700 active:bg-gray-200">6</button>
                    <button onclick="addToPin('7')" class="w-16 h-16 rounded-full bg-white border border-gray-200 shadow hover:bg-gray-50 text-xl font-medium text-gray-700 active:bg-gray-200">7</button>
                    <button onclick="addToPin('8')" class="w-16 h-16 rounded-full bg-white border border-gray-200 shadow hover:bg-gray-50 text-xl font-medium text-gray-700 active:bg-gray-200">8</button>
                    <button onclick="addToPin('9')" class="w-16 h-16 rounded-full bg-white border border-gray-200 shadow hover:bg-gray-50 text-xl font-medium text-gray-700 active:bg-gray-200">9</button>
                    <button onclick="clearPin()" class="w-16 h-16 rounded-full bg-red-50 text-red-700 font-bold hover:bg-red-100 flex items-center justify-center"><i class="fas fa-times"></i></button>
                    <button onclick="addToPin('0')" class="w-16 h-16 rounded-full bg-white border border-gray-200 shadow hover:bg-gray-50 text-xl font-medium text-gray-700 active:bg-gray-200">0</button>
                    <button onclick="attemptLogin()" class="w-16 h-16 rounded-full bg-audi-red text-white shadow hover:bg-red-800 flex items-center justify-center"><i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <div class="flex space-x-4 mt-8">
                <button onclick="showView('register')" class="text-sm text-gray-500 hover:text-black underline">Register New User</button>
                <span class="text-gray-300">|</span>
                <button onclick="forgotPin()" class="text-sm text-gray-500 hover:text-black underline">Forgot PIN?</button>
            </div>
        </div>

        <!-- VIEW: Register Screen -->
        <div id="view-register" class="hidden flex-1 flex flex-col items-center justify-center max-w-md mx-auto w-full">
            <h2 class="text-2xl font-bold mb-6">Create Account</h2>
            
            <div class="w-full space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="reg-name" class="w-full p-3 border border-gray-300 rounded focus:border-red-600 outline-none" placeholder="John Doe">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select id="reg-role" onchange="toggleEmailField()" class="w-full p-3 border border-gray-300 rounded focus:border-red-600 outline-none">
                        <option value="employee">Employee</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>

                <div id="email-field-container" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email (For Admin Recovery)</label>
                    <input type="email" id="reg-email" class="w-full p-3 border border-gray-300 rounded focus:border-red-600 outline-none" placeholder="admin@audiwyomingvalley.com">
                </div>

                <button onclick="registerUser()" class="w-full bg-audi-red text-white py-3 rounded font-bold hover:bg-red-800 transition shadow-lg mt-4">
                    Generate PIN & Register
                </button>
                
                <button onclick="showView('login')" class="w-full text-gray-500 py-2 hover:text-black">Cancel</button>
            </div>
        </div>

        <!-- VIEW: Employee Dashboard -->
        <div id="view-employee" class="hidden flex-1 flex flex-col">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Hello, <span id="emp-name" class="text-red-700">User</span></h2>
                    <p class="text-gray-500" id="current-date-display">February 7, 2026</p>
                </div>
                <button onclick="logout()" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>

            <!-- Status Indicator -->
            <div class="bg-gray-100 p-4 rounded-lg mb-8 text-center border-l-4 border-gray-400" id="status-bar">
                <span class="text-gray-600 font-medium uppercase tracking-wide">Current Status:</span>
                <span id="current-status" class="ml-2 font-bold text-xl">Not Clocked In</span>
                <div id="timer-display" class="mt-2 text-2xl font-mono text-gray-700 hidden">00:00:00</div>
            </div>

            <!-- Action Grid -->
            <div class="grid grid-cols-2 gap-6 flex-1">
                <button onclick="handleClockAction('clockIn')" id="btn-clock-in" class="btn-action bg-green-600 text-white rounded-xl p-6 flex flex-col items-center justify-center shadow-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-stopwatch text-4xl mb-3"></i>
                    <span class="text-xl font-bold">Clock In</span>
                </button>

                <button onclick="handleClockAction('clockOut')" id="btn-clock-out" class="btn-action bg-gray-800 text-white rounded-xl p-6 flex flex-col items-center justify-center shadow-lg hover:bg-black disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-door-open text-4xl mb-3"></i>
                    <span class="text-xl font-bold">Clock Out</span>
                </button>
                
                <button onclick="handleClockAction('startLunch')" id="btn-lunch-start" class="btn-action bg-yellow-500 text-white rounded-xl p-6 flex flex-col items-center justify-center shadow-lg hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-utensils text-4xl mb-3"></i>
                    <span class="text-xl font-bold">Start Lunch</span>
                </button>

                <button onclick="handleClockAction('endLunch')" id="btn-lunch-end" class="btn-action bg-blue-500 text-white rounded-xl p-6 flex flex-col items-center justify-center shadow-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-briefcase text-4xl mb-3"></i>
                    <span class="text-xl font-bold">End Lunch</span>
                </button>
            </div>

            <div class="mt-8">
                <h3 class="font-bold text-gray-700 mb-2">Today's Activity</h3>
                <div id="employee-log-today" class="bg-white rounded border p-4 text-sm text-gray-600 min-h-[100px]">
                    No activity yet today.
                </div>
            </div>
        </div>

        <!-- VIEW: Admin Dashboard -->
        <div id="view-admin" class="hidden flex-1 flex flex-col w-full">
            <div class="flex justify-between items-center mb-6 no-print">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Admin Dashboard</h2>
                    <p class="text-sm text-gray-500">Manage records and personnel</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="changeAdminPin()" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm">
                        <i class="fas fa-key mr-1"></i> My PIN
                    </button>
                    <button onclick="logout()" class="px-4 py-2 bg-gray-800 text-white rounded hover:bg-black">
                        Logout
                    </button>
                </div>
            </div>

            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 bg-white p-4 rounded shadow-sm no-print">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Filter by Employee</label>
                    <select id="admin-filter-emp" onchange="renderAdminTable()" class="w-full border p-1 rounded mt-1">
                        <option value="all">All Employees</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Action</label>
                    <button onclick="window.print()" class="w-full mt-1 bg-blue-600 text-white py-1.5 rounded hover:bg-blue-700">
                        <i class="fas fa-print mr-2"></i> Print / PDF
                    </button>
                </div>
                 <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Data</label>
                    <button onclick="clearHistory()" class="w-full mt-1 bg-red-100 text-red-700 py-1.5 rounded hover:bg-red-200 border border-red-200">
                        <i class="fas fa-trash mr-2"></i> Clear History
                    </button>
                </div>
            </div>

            <!-- Report Area (Printable) -->
            <div id="print-area" class="flex-1 bg-white rounded shadow overflow-hidden flex flex-col">
                <div class="hidden print-header mb-4 border-b pb-4">
                    <img src="audi-logo.jpg" class="h-16 mb-2" onerror="this.style.display='none'">
                    <h1 class="text-2xl font-bold">Attendance Report</h1>
                    <p id="report-date" class="text-gray-500"></p>
                </div>

                <div class="overflow-auto flex-1">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 text-sm uppercase tracking-wider sticky top-0">
                                <th class="p-3 border-b">Employee</th>
                                <th class="p-3 border-b">Date</th>
                                <th class="p-3 border-b">In</th>
                                <th class="p-3 border-b">Lunch Start</th>
                                <th class="p-3 border-b">Lunch End</th>
                                <th class="p-3 border-b">Out</th>
                                <th class="p-3 border-b text-right">Total Hours</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="text-sm text-gray-700">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>
                
                <div class="p-4 border-t bg-gray-50 text-right font-bold text-gray-800">
                    Total Hours Recorded: <span id="total-hours-sum">0.00</span>
                </div>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <div id="modal-success" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center max-w-sm w-full">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-2xl text-green-600"></i>
            </div>
            <h3 class="text-xl font-bold mb-2">Success!</h3>
            <p id="modal-msg" class="text-gray-600 mb-6"></p>
            <div id="pin-display" class="hidden text-4xl font-mono font-bold text-audi-red tracking-widest mb-6 bg-gray-100 p-4 rounded"></div>
            <button onclick="closeModal()" class="w-full bg-gray-800 text-white py-2 rounded hover:bg-black">Close</button>
        </div>
    </div>

    <script>
        // --- Data Management (LocalStorage) ---
        const APP_KEY = 'audi_tracker_v1';
        
        const db = {
            get: () => {
                const data = localStorage.getItem(APP_KEY);
                return data ? JSON.parse(data) : { users: [], logs: [] };
            },
            save: (data) => {
                localStorage.setItem(APP_KEY, JSON.stringify(data));
            },
            addUser: (user) => {
                const data = db.get();
                data.users.push(user);
                db.save(data);
            },
            addLog: (log) => {
                const data = db.get();
                data.logs.push(log);
                db.save(data);
            },
            updateLog: (logId, updates) => {
                const data = db.get();
                const index = data.logs.findIndex(l => l.id === logId);
                if (index !== -1) {
                    data.logs[index] = { ...data.logs[index], ...updates };
                    db.save(data);
                }
            },
            updateUser: (userId, updates) => {
                 const data = db.get();
                 const index = data.users.findIndex(u => u.id === userId);
                 if(index !== -1) {
                     data.users[index] = {...data.users[index], ...updates};
                     db.save(data);
                 }
            }
        };

        // --- State ---
        let currentUser = null;
        let pinBuffer = '';

        // --- Auth Functions ---
        function addToPin(digit) {
            if (pinBuffer.length < 5) {
                pinBuffer += digit;
                updatePinInput();
            }
        }

        function clearPin() {
            pinBuffer = '';
            updatePinInput();
        }

        function updatePinInput() {
            const input = document.getElementById('pin-input');
            input.value = pinBuffer; // Show actual numbers or mask
            input.setAttribute('type', 'password');
        }

        function attemptLogin() {
            const data = db.get();
            const user = data.users.find(u => u.pin === pinBuffer);

            if (user) {
                login(user);
            } else {
                showNotification('Invalid PIN', 'error');
                pinBuffer = '';
                updatePinInput();
                // Add shake animation
                const input = document.getElementById('pin-input');
                input.classList.add('border-red-500');
                setTimeout(() => input.classList.remove('border-red-500'), 500);
            }
        }

        function login(user) {
            currentUser = user;
            pinBuffer = '';
            updatePinInput();

            if (user.role === 'admin') {
                showView('admin');
                renderAdminDash();
            } else {
                showView('employee');
                renderEmployeeDash();
            }
            showNotification(`Welcome back, ${user.name}`);
        }

        function logout() {
            currentUser = null;
            showView('login');
        }

        function forgotPin() {
            const email = prompt("Please enter your registered email address for recovery:");
            if(!email) return;

            const data = db.get();
            // In a real app, this would be a server call.
            // Since this is local, we allow recovery for Admins only via this simulated method 
            // OR if it's an employee, we tell them to ask admin.
            
            const admin = data.users.find(u => u.role === 'admin' && u.email.toLowerCase() === email.toLowerCase());
            
            if(admin) {
                // Simulating email sent
                alert(`Recovery Email Sent to ${email}\n\n(SIMULATION: Your PIN is ${admin.pin})`);
            } else {
                alert("Email not found or you are not an administrator. Please ask an Administrator to reset your PIN.");
            }
        }

        // --- Registration ---
        function toggleEmailField() {
            const role = document.getElementById('reg-role').value;
            const container = document.getElementById('email-field-container');
            if (role === 'admin') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function generatePIN() {
            // Generate unique 4 digit pin
            const data = db.get();
            let pin;
            let isUnique = false;
            while (!isUnique) {
                pin = Math.floor(1000 + Math.random() * 9000).toString();
                if (!data.users.find(u => u.pin === pin)) isUnique = true;
            }
            return pin;
        }

        function registerUser() {
            const name = document.getElementById('reg-name').value;
            const role = document.getElementById('reg-role').value;
            const email = document.getElementById('reg-email').value;

            if (!name) {
                showNotification("Name is required", 'error');
                return;
            }
            if (role === 'admin' && !email) {
                showNotification("Email is required for Admins", 'error');
                return;
            }

            const pin = generatePIN();
            const newUser = {
                id: Date.now().toString(),
                name: name,
                role: role,
                email: email,
                pin: pin,
                joined: new Date().toISOString()
            };

            db.addUser(newUser);
            
            // Clear Form
            document.getElementById('reg-name').value = '';
            document.getElementById('reg-email').value = '';
            
            // Show Success Modal with PIN
            document.getElementById('modal-msg').innerText = `${name} has been registered successfully.`;
            const pinDisplay = document.getElementById('pin-display');
            pinDisplay.innerText = pin;
            pinDisplay.classList.remove('hidden');
            document.getElementById('modal-success').classList.remove('hidden');
        }

        function changeAdminPin() {
            const newPin = prompt("Enter new 4-digit PIN:");
            if (newPin && newPin.length >= 4) {
                 db.updateUser(currentUser.id, { pin: newPin });
                 alert("PIN updated successfully. Please memorize it.");
            } else {
                alert("Invalid PIN format.");
            }
        }

        // --- Logic: Time Tracking ---
        function renderEmployeeDash() {
            document.getElementById('emp-name').innerText = currentUser.name;
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('en-US', options);

            updateButtons();
            renderTodayLog();
        }

        function getTodayLog() {
            const data = db.get();
            const today = new Date().toDateString();
            // Find a log for this user today that hasn't been closed (clocked out) fully or just the latest one
            return data.logs.find(l => l.userId === currentUser.id && l.dateString === today);
        }

        function updateButtons() {
            const log = getTodayLog();
            const statusEl = document.getElementById('current-status');
            const bar = document.getElementById('status-bar');
            
            // Button Refs
            const bIn = document.getElementById('btn-clock-in');
            const bOut = document.getElementById('btn-clock-out');
            const bLStart = document.getElementById('btn-lunch-start');
            const bLEnd = document.getElementById('btn-lunch-end');

            // Reset Styles
            bIn.disabled = true;
            bOut.disabled = true;
            bLStart.disabled = true;
            bLEnd.disabled = true;
            bar.className = "p-4 rounded-lg mb-8 text-center border-l-4";

            if (!log) {
                // Status: Not worked yet today
                statusEl.innerText = "Ready to Start";
                bar.classList.add('bg-gray-100', 'border-gray-400');
                bIn.disabled = false;
            } else if (log.clockIn && !log.clockOut) {
                // Currently Working OR at Lunch
                if (log.lunchStart && !log.lunchEnd) {
                    // AT LUNCH
                    statusEl.innerText = "On Lunch Break";
                    bar.classList.add('bg-yellow-100', 'border-yellow-500');
                    bLEnd.disabled = false;
                } else {
                    // WORKING
                    statusEl.innerText = "Clocked In (Working)";
                    bar.classList.add('bg-green-100', 'border-green-500');
                    // Can start lunch if haven't taken it, or clock out
                    if (!log.lunchStart) bLStart.disabled = false;
                    bOut.disabled = false;
                }
            } else if (log.clockIn && log.clockOut) {
                // FINISHED TODAY
                statusEl.innerText = "Shift Complete";
                bar.classList.add('bg-blue-100', 'border-blue-500');
            }
        }

        function handleClockAction(action) {
            const data = db.get();
            const today = new Date().toDateString();
            const now = new Date().toISOString();
            
            let log = data.logs.find(l => l.userId === currentUser.id && l.dateString === today);

            if (action === 'clockIn') {
                if (log) return; // Already exists
                const newLog = {
                    id: Date.now().toString(),
                    userId: currentUser.id,
                    userName: currentUser.name, // Store name snapshot
                    dateString: today,
                    clockIn: now,
                    lunchStart: null,
                    lunchEnd: null,
                    clockOut: null,
                    totalHours: 0
                };
                db.addLog(newLog);
                showNotification("Clocked In Successfully");
            } 
            else if (action === 'startLunch') {
                if (!log) return;
                db.updateLog(log.id, { lunchStart: now });
                showNotification("Lunch Break Started");
            }
            else if (action === 'endLunch') {
                if (!log) return;
                db.updateLog(log.id, { lunchEnd: now });
                showNotification("Welcome Back from Lunch");
            }
            else if (action === 'clockOut') {
                if (!log) return;
                // Calculate Total Hours
                const start = new Date(log.clockIn);
                const end = new Date(now);
                let diffMs = end - start;

                // Deduct lunch
                if (log.lunchStart && log.lunchEnd) {
                    const lStart = new Date(log.lunchStart);
                    const lEnd = new Date(log.lunchEnd);
                    diffMs -= (lEnd - lStart);
                }

                const hours = (diffMs / (1000 * 60 * 60)).toFixed(2);

                db.updateLog(log.id, { clockOut: now, totalHours: hours });
                showNotification(`Clocked Out. Total: ${hours} hrs`);
            }

            renderEmployeeDash();
        }

        function formatTime(isoString) {
            if (!isoString) return '--:--';
            return new Date(isoString).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function renderTodayLog() {
            const log = getTodayLog();
            const container = document.getElementById('employee-log-today');
            if (!log) {
                container.innerHTML = "No logs for today.";
                return;
            }
            
            container.innerHTML = `
                <div class="flex justify-between items-center py-1"><span>Clock In:</span> <span class="font-bold">${formatTime(log.clockIn)}</span></div>
                <div class="flex justify-between items-center py-1"><span>Lunch Start:</span> <span class="font-bold">${formatTime(log.lunchStart)}</span></div>
                <div class="flex justify-between items-center py-1"><span>Lunch End:</span> <span class="font-bold">${formatTime(log.lunchEnd)}</span></div>
                <div class="flex justify-between items-center py-1"><span>Clock Out:</span> <span class="font-bold">${formatTime(log.clockOut)}</span></div>
            `;
        }

        // --- Admin Logic ---
        function renderAdminDash() {
            // Populate Filter
            const data = db.get();
            const select = document.getElementById('admin-filter-emp');
            select.innerHTML = '<option value="all">All Employees</option>';
            data.users.forEach(u => {
                // Only show employees in filter, or everyone
                const opt = document.createElement('option');
                opt.value = u.id;
                opt.innerText = u.name;
                select.appendChild(opt);
            });

            renderAdminTable();
        }

        function renderAdminTable() {
            const data = db.get();
            const filterId = document.getElementById('admin-filter-emp').value;
            const tbody = document.getElementById('admin-table-body');
            tbody.innerHTML = '';

            let logs = data.logs;
            if (filterId !== 'all') {
                logs = logs.filter(l => l.userId === filterId);
            }

            // Sort by date (newest first)
            logs.sort((a, b) => new Date(b.clockIn) - new Date(a.clockIn));

            let totalSum = 0;

            logs.forEach(log => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                
                const dateObj = new Date(log.clockIn);
                
                tr.innerHTML = `
                    <td class="p-3 font-medium">${log.userName}</td>
                    <td class="p-3">${dateObj.toLocaleDateString()}</td>
                    <td class="p-3 text-green-700">${formatTime(log.clockIn)}</td>
                    <td class="p-3 text-orange-600">${formatTime(log.lunchStart)}</td>
                    <td class="p-3 text-blue-600">${formatTime(log.lunchEnd)}</td>
                    <td class="p-3 text-red-700">${formatTime(log.clockOut)}</td>
                    <td class="p-3 text-right font-bold">${log.totalHours || 'Running'}</td>
                `;
                tbody.appendChild(tr);

                if (log.totalHours) totalSum += parseFloat(log.totalHours);
            });

            document.getElementById('total-hours-sum').innerText = totalSum.toFixed(2);
            document.getElementById('report-date').innerText = `Generated on ${new Date().toLocaleString()}`;
        }

        function clearHistory() {
            if (confirm("Are you sure you want to delete ALL attendance records? This cannot be undone.")) {
                const data = db.get();
                data.logs = [];
                db.save(data);
                renderAdminTable();
                showNotification("History Cleared");
            }
        }

        // --- Utility UI Functions ---
        function showView(viewId) {
            ['view-login', 'view-register', 'view-employee', 'view-admin'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            
            // If viewing login, reset
            if (viewId === 'login') {
                clearPin();
            }
        }

        function showNotification(msg, type='success') {
            const el = document.getElementById('notification');
            el.innerText = msg;
            el.classList.remove('hidden');
            el.className = `fixed top-5 right-5 px-6 py-3 rounded shadow-lg text-white font-bold z-50 transition-all duration-300 transform translate-y-0 ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
            
            setTimeout(() => {
                el.classList.add('hidden');
            }, 3000);
        }

        function closeModal() {
            document.getElementById('modal-success').classList.add('hidden');
            showView('login'); // Return to login after registration
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is typing PIN on keyboard
            document.addEventListener('keydown', (e) => {
                if (document.getElementById('view-login').classList.contains('hidden')) return;
                
                if (e.key >= '0' && e.key <= '9') {
                    addToPin(e.key);
                } else if (e.key === 'Backspace') {
                    pinBuffer = pinBuffer.slice(0, -1);
                    updatePinInput();
                } else if (e.key === 'Enter') {
                    attemptLogin();
                }
            });
        });

    </script>
</body>
</html>